# Connect Sphere Database Schema

This document outlines the schema for the Connect Sphere database, including tables, enums, functions, triggers, and Row Level Security (RLS) policies.

---

## Enums (Custom Types)

### `public.privacy_level`
```sql
CREATE TYPE public.privacy_level AS ENUM (
  'public',
  'followers',
  'private'
);
```

### `public.reaction_type`
```sql
CREATE TYPE public.reaction_type AS ENUM (
  'like',
  'love',
  'laugh',
  'wow',
  'sad',
  'angry'
);
```

### `public.collab_status`
```sql
CREATE TYPE public.collab_status AS ENUM (
  'pending',
  'accepted',
  'declined'
);
```

---

## Tables

### `public.profiles`
Stores user profile data.
```sql
CREATE TABLE public.profiles (
  id uuid NOT NULL PRIMARY KEY,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NULL,
  display_name text NULL,
  username text UNIQUE NULL,
  bio text NULL,
  avatar_url text NULL,
  website text NULL,
  location text NULL,
  follower_count integer DEFAULT 0,
  following_count integer DEFAULT 0,
  is_verified boolean DEFAULT false,
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users (id) ON DELETE CASCADE
);
```

### `public.privacy_settings`
Stores privacy preferences for users.
```sql
CREATE TABLE public.privacy_settings (
  user_id uuid NOT NULL PRIMARY KEY,
  profile_visibility public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  post_visibility public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  show_online_status boolean NOT NULL DEFAULT true,
  allow_follow_requests boolean NOT NULL DEFAULT true,
  allow_direct_messages public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  show_followers boolean NOT NULL DEFAULT true,
  show_following boolean NOT NULL DEFAULT true,
  allow_tagging boolean NOT NULL DEFAULT true,
  allow_mentions public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NULL,
  CONSTRAINT privacy_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);
```

### `public.followers`
Stores accepted follow relationships.
```sql
CREATE TABLE public.followers (
  follower_id uuid NOT NULL,
  following_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  PRIMARY KEY (follower_id, following_id),
  CONSTRAINT followers_follower_id_fkey FOREIGN KEY (follower_id) REFERENCES profiles (id) ON DELETE CASCADE,
  CONSTRAINT followers_following_id_fkey FOREIGN KEY (following_id) REFERENCES profiles (id) ON DELETE CASCADE
);

CREATE TRIGGER on_new_follow
AFTER INSERT ON public.followers
FOR EACH ROW
EXECUTE FUNCTION handle_new_follower();

CREATE TRIGGER on_unfollow
AFTER DELETE ON public.followers
FOR EACH ROW
EXECUTE FUNCTION handle_lost_follower();
```

### `public.follow_requests`
Stores pending follow requests.
```sql
CREATE TABLE public.follow_requests (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  follower_id uuid NOT NULL,
  following_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT follow_requests_follower_id_fkey FOREIGN KEY (follower_id) REFERENCES profiles (id) ON DELETE CASCADE,
  CONSTRAINT follow_requests_following_id_fkey FOREIGN KEY (following_id) REFERENCES profiles (id) ON DELETE CASCADE,
  CONSTRAINT follow_requests_unique UNIQUE (follower_id, following_id)
);
```

### `public.posts`
```sql
CREATE TABLE public.posts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid NOT NULL,
  text text NULL,
  media jsonb[] NULL,
  hashtags text[] NULL,
  location text NULL,
  visibility public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  is_private boolean NOT NULL DEFAULT false,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NULL,
  like_count integer DEFAULT 0,
  share_count integer DEFAULT 0,
  save_count integer DEFAULT 0,
  comment_count integer DEFAULT 0,
  collaborators jsonb DEFAULT '[]'::jsonb,
  CONSTRAINT posts_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);
```

### `public.comments`
```sql
CREATE TABLE public.comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  text text NOT NULL,
  parent_id BIGINT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT comments_post_id_fkey FOREIGN KEY (post_id) REFERENCES posts (id) ON DELETE CASCADE,
  CONSTRAINT comments_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE,
  CONSTRAINT comments_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES comments (id) ON DELETE CASCADE
);

CREATE TRIGGER comments_after_change
AFTER INSERT OR DELETE ON comments
FOR EACH ROW
EXECUTE FUNCTION update_comment_count();
```

### `public.likes`
```sql
CREATE TABLE public.likes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT likes_post_id_user_id_key UNIQUE (post_id, user_id),
  CONSTRAINT likes_post_id_fkey FOREIGN KEY (post_id) REFERENCES posts (id) ON DELETE CASCADE,
  CONSTRAINT likes_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);

CREATE TRIGGER likes_after_change
AFTER INSERT OR DELETE ON likes
FOR EACH ROW
EXECUTE FUNCTION update_like_count();
```

### `public.bookmarks`
```sql
CREATE TABLE public.bookmarks (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT bookmarks_post_id_user_id_key UNIQUE (post_id, user_id),
  CONSTRAINT bookmarks_post_id_fkey FOREIGN KEY (post_id) REFERENCES posts (id) ON DELETE CASCADE,
  CONSTRAINT bookmarks_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);

CREATE TRIGGER bookmarks_after_change
AFTER INSERT OR DELETE ON bookmarks
FOR EACH ROW
EXECUTE FUNCTION update_save_count();
```

### `public.shares`
```sql
CREATE TABLE public.shares (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT shares_post_id_fkey FOREIGN KEY (post_id) REFERENCES posts (id) ON DELETE CASCADE,
  CONSTRAINT shares_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);

CREATE TRIGGER shares_after_change
AFTER INSERT OR DELETE ON shares
FOR EACH ROW
EXECUTE FUNCTION update_share_count();
```

### `public.collaboration_invites`
Stores pending and processed collaboration requests for posts.
```sql
CREATE TABLE public.collaboration_invites (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id bigint NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
  inviter_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  invitee_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  role text NOT NULL DEFAULT 'coauthor',
  status public.collab_status NOT NULL DEFAULT 'pending',
  invited_at timestamp with time zone NOT NULL DEFAULT now(),
  responded_at timestamp with time zone NULL,
  accepted_at timestamp with time zone NULL,
  UNIQUE(post_id, invitee_id)
);

CREATE TRIGGER on_collab_invite_created
AFTER INSERT ON public.collaboration_invites
FOR EACH ROW EXECUTE FUNCTION public.handle_new_collab_invite();
```

### `public.notifications`
General-purpose notifications table for system events, likes, comments, and collaboration invites.
```sql
CREATE TABLE public.notifications (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  actor_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL,
  type text NOT NULL CHECK (type IN ('like', 'comment', 'follow', 'system', 'collab')),
  title text,
  body text,
  metadata jsonb DEFAULT '{}'::jsonb,
  is_read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now()
);
```

---

## Functions
- handle_new_user()
- handle_new_follower()
- handle_lost_follower()
- accept_follow_request()
- accept_all_follow_requests()
- update_comment_count()
- update_like_count()
- update_save_count()
- update_share_count()
- accept_collab_invite(invite_id bigint)
- decline_collab_invite(invite_id bigint)
- handle_new_collab_invite()

---

## Row Level Security Policies

### `public.profiles`
```sql
CREATE POLICY "Public profiles are viewable by everyone"
ON public.profiles FOR SELECT
USING (true);

CREATE POLICY "Users can update own profile"
ON public.profiles FOR UPDATE
USING (auth.uid() = id);
```

### `public.posts`
```sql
CREATE POLICY "Public posts are viewable by everyone"
ON public.posts FOR SELECT
USING (visibility = 'public');

CREATE POLICY "Users can insert their own posts"
ON public.posts FOR INSERT
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own posts"
ON public.posts FOR UPDATE
USING (auth.uid() = user_id);
```

### `public.follow_requests`
```sql
CREATE POLICY "Allow read on requests"
ON public.follow_requests
FOR SELECT USING (auth.uid() = following_id OR auth.uid() = follower_id);

CREATE POLICY "Allow user to send a request"
ON public.follow_requests
FOR INSERT WITH CHECK (auth.uid() = follower_id);

CREATE POLICY "Allow user to delete a request"
ON public.follow_requests
FOR DELETE USING (auth.uid() = follower_id OR auth.uid() = following_id);
```

### `public.collaboration_invites`
```sql
CREATE POLICY "Users can view their own collab invites"
ON public.collaboration_invites FOR SELECT
TO authenticated
USING (auth.uid() = inviter_id OR auth.uid() = invitee_id);

CREATE POLICY "Post owners can insert collab invites"
ON public.collaboration_invites FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = inviter_id AND EXISTS (SELECT 1 FROM public.posts WHERE id = post_id AND user_id = auth.uid()));

CREATE POLICY "Invitees can update their own invites"
ON public.collaboration_invites FOR UPDATE
TO authenticated
USING (auth.uid() = invitee_id);
```

### `public.notifications`
```sql
CREATE POLICY "Users can see their own notifications"
ON public.notifications FOR SELECT
TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "Users can update their own notifications"
ON public.notifications FOR UPDATE
TO authenticated
USING (auth.uid() = user_id);
```
